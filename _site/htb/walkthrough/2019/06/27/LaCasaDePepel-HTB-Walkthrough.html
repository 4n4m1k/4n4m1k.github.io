<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="Your awesome title" property="og:site_name">

  <meta content="LaCasaDePapel HTB Walkthrough" property="og:title">


  <meta content="article" property="og:type">


  <meta content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." property="og:description">


  <meta content="http://localhost:4000/htb/walkthrough/2019/06/27/LaCasaDePepel-HTB-Walkthrough.html" property="og:url">


  <meta content="2019-06-27T00:00:00-04:00" property="article:published_time">
  <meta content="http://localhost:4000/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="HTB" property="article:section">
  


  

  <title>LaCasaDePapel HTB Walkthrough</title>
  <meta name="description" content="Hello!LaCasaDePapel just retired today and this my writeup for it. This is my first writeup so if you have any feedback then please let me know.&lt;H4&gt;&lt...">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="http://localhost:4000/htb/walkthrough/2019/06/27/LaCasaDePepel-HTB-Walkthrough.html">
  <link rel="alternate" type="application/rss+xml" title="Your awesome title" href="http://localhost:4000/feed.xml">
</head>


  <body>
<!-- <!-- <a href="https://github.com/hemangsk/DevJournal"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 9999;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a> 
-->

<section>
<nav class="navbar navbar-default navbar-fixed-top">

  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Your awesome title</a>
    </div>


    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        

        
        
        <li><a href="/about/">About</a></li>

        

        
        
        <li><a href="/download/">Download</a></li>

        

        
        

        
        

        
        

        
        

        
        

        


      </ul>

    <!--  <ul class="nav navbar-nav navbar-right">
        <li><a href="#">Know More!</a></li>

      </ul>-->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
</section>
 -->
<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">LaCasaDePapel HTB Walkthrough</h1>
      <p class="post-meta"><time datetime="2019-06-27T00:00:00-04:00" itemprop="datePublished">Jun 27, 2019</time> â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">4n4m1k</span></span></p>
      
    </div>

</div>


  <div class="post-content container" itemprop="articleBody">
    <h4>Hello!</h4>
<h4>LaCasaDePapel just retired today and this my writeup for it. This is my first writeup so if you have any feedback then please let me know.&lt;H4&gt;
&lt;H4&gt;This was an interesting box with some CTF type features. Overall, I had fun hacking this box.</h4>
<p><br /></p>

<h1>Enumeration:  </h1>
<h4>Nmap</h4>
<p>First thing that I start with is, Port Scanning.<br />
<br />
<code class="highlighter-rouge">nmap -sC -sV -oA nmap/initial 10.10.10.131 -vvv</code>
<br /></p>

<figure class="highlight">
  <pre><code class="language-html" data-lang="html">PORT    STATE SERVICE  REASON  VERSION
21/tcp  open  ftp      syn-ack vsftpd 2.3.4
22/tcp  open  ssh      syn-ack OpenSSH 7.9 (protocol 2.0)
| ssh-hostkey: 
|   2048 03:e1:c2:c9:79:1c:a6:6b:51:34:8d:7a:c3:c7:c8:50 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNzmarvyIINA+hjsLo2xYn1PUyzuTflhtXQs8S1Z56FzbdzXs6FiwhoRGn63XuGCHqCfEzHmh1cg4HGLfGAMwe+AsdJ8hLd/ISNRECH8yvM+9k78Aio3pe+lYbiWSQWyJrQdeqJXyDJFSd6BR3Cr6/rwSvE7N3eWeQvxS+fsg5HOER6n8SOnXvqpWYUo+XmZxGzmluNfsqoJ6doJCyW3X4sTImTlpmRmee6iseo9neZO18aHsARxlkHCqUhp1SBzIiik3DurtH1tgrn8ntfNiK3q0FZJmh9qzu0P/L50j8bzlJdvAsLuqbYmVZhqFs0JfBVdyVTFMn4O0J+IqRrXAF
|   256 41:e4:95:a3:39:0b:25:f9:da:de:be:6a:dc:59:48:6d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBNli8Xx10a0s+zrkT1eVfM1kRaAQaK+a/mxYxhPxpK0094QFQBcVrvrXb3+j4M8l2G/C9CtQRWVXpX8ajWhYRik=
|   256 30:0b:c6:66:2b:8f:5e:4f:26:28:75:0e:f5:b1:71:e4 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB2uNaKo2PK5cMci4E7dNWQ6ipiEzG3cWUR56qqMZqYR
80/tcp  open  http     syn-ack Node.js (Express middleware)
|_http-favicon: Unknown favicon MD5: 621D76BDE56526A10B529BF2BC0776CA
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: La Casa De Papel
443/tcp open  ssl/http syn-ack Node.js Express framework
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Server returned status 401 but no WWW-Authenticate header.
|_http-favicon: Unknown favicon MD5: 621D76BDE56526A10B529BF2BC0776CA
| http-methods: 
|_  Supported Methods: GET HEAD POST
|_http-title: La Casa De Papel
| ssl-cert: Subject: commonName=lacasadepapel.htb/organizationName=La Casa De Papel
| Issuer: commonName=lacasadepapel.htb/organizationName=La Casa De Papel
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2019-01-27T08:35:30
| Not valid after:  2029-01-24T08:35:30
| MD5:   6ea4 933a a347 ce50 8c40 5f9b 1ea8 8e9a
| SHA-1: 8c47 7f3e 53d8 e76b 4cdf ecca adb6 0551 b1b6 38d4
| -----BEGIN CERTIFICATE-----
| MIIC6jCCAdICCQDISiE8M6B29jANBgkqhkiG9w0BAQsFADA3MRowGAYDVQQDDBFs
| YWNhc2FkZXBhcGVsLmh0YjEZMBcGA1UECgwQTGEgQ2FzYSBEZSBQYXBlbDAeFw0x
| OTAxMjcwODM1MzBaFw0yOTAxMjQwODM1MzBaMDcxGjAYBgNVBAMMEWxhY2FzYWRl
| cGFwZWwuaHRiMRkwFwYDVQQKDBBMYSBDYXNhIERlIFBhcGVsMIIBIjANBgkqhkiG
| 9w0BAQEFAAOCAQ8AMIIBCgKCAQEAz3M6VN7OD5sHW+zCbIv/5vJpuaxJF3A5q2rV
| QJNqU1sFsbnaPxRbFgAtc8hVeMNii2nCFO8PGGs9P9pvoy8e8DR9ksBQYyXqOZZ8
| /rsdxwfjYVgv+a3UbJNO4e9Sd3b8GL+4XIzzSi3EZbl7dlsOhl4+KB4cM4hNhE5B
| 4K8UKe4wfKS/ekgyCRTRENVqqd3izZzz232yyzFvDGEOFJVzmhlHVypqsfS9rKUV
| ESPHczaEQld3kupVrt/mBqwuKe99sluQzORqO1xMqbNgb55ZD66vQBSkN2PwBeiR
| PBRNXfnWla3Gkabukpu9xR9o+l7ut13PXdQ/fPflLDwnu5wMZwIDAQABMA0GCSqG
| SIb3DQEBCwUAA4IBAQCuo8yzORz4pby9tF1CK/4cZKDYcGT/wpa1v6lmD5CPuS+C
| hXXBjK0gPRAPhpF95DO7ilyJbfIc2xIRh1cgX6L0ui/SyxaKHgmEE8ewQea/eKu6
| vmgh3JkChYqvVwk7HRWaSaFzOiWMKUU8mB/7L95+mNU7DVVUYB9vaPSqxqfX6ywx
| BoJEm7yf7QlJTH3FSzfew1pgMyPxx0cAb5ctjQTLbUj1rcE9PgcSki/j9WyJltkI
| EqSngyuJEu3qYGoM0O5gtX13jszgJP+dA3vZ1wqFjKlWs2l89pb/hwRR2raqDwli
| MgnURkjwvR1kalXCvx9cST6nCkxF2TxlmRpyNXy4
|_-----END CERTIFICATE-----
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|_  http/1.1
| tls-nextprotoneg: 
|   http/1.1
|_  http/1.0
Service Info: OS: Unix</code></pre>
</figure>

<p><br /></p>

<p><br /></p>

<p>Page on <code class="highlighter-rouge">http://10.10.10.131</code>
<br />
<img src="/images/hackthebox/lacasa/80.png" width="90%" />
<br />
<br />
Page on <code class="highlighter-rouge">https://10.10.10.131</code>
<br />
<img src="/images/hackthebox/lacasa/website.png" width="90%" />
<br /></p>

<p><br /></p>
<h1>Exploitation:</h1>
<p>I started to search exploits for the services found on nmap. 
By searching exploit of vsftpd 2.3.4 on google, we land to this page 
<code class="highlighter-rouge">https://sweshsec.wordpress.com/2015/07/31/vsftpd-vulnerability-exploitation-with-manual-approach/</code>
<br />
The exploit: 
If we try to log into the FTP server with a username ending with <code class="highlighter-rouge">:)</code> and any password, then a backdoor opens at port <code class="highlighter-rouge">6200</code>.
<br /></p>

<figure class="highlight">
  <pre><code class="language-html" data-lang="html">ftp 10.10.10.131
Connected to 10.10.10.131.
220 (vsFTPd 2.3.4)
Name (10.10.10.131:an4m1k): user:)
331 Please specify the password.
Password:</code></pre>
</figure>

<p>The shell freezes after this.</p>

<p>Letâ€™s try to connect to port <code class="highlighter-rouge">6200</code> as per the exploit.
<br />
<code class="highlighter-rouge">nc -nv 10.10.10.131 6200</code> 
<br />
<img src="/images/hackthebox/lacasa/6200.png" alt="" />
<br />
It looks like a php shell, so I assumed that it will interpret php commands. If we try any system commands then the system doesnâ€™t recognize those commands.
After trying some commands, I found something interesting.
<br />
<img src="/images/hackthebox/lacasa/6200 help.png" alt="" />
<br />
After trying multiple commands with <code class="highlighter-rouge">sudo</code>, I found some commands that worked.
<br />
<code class="highlighter-rouge">scandir:</code> Returns an array of files and directories from directory.
<br />
<img src="/images/hackthebox/lacasa/scandir.png" alt="" />
<br />
<br />
We can see the files and we can read the files by using <code class="highlighter-rouge">file_get_contents</code>.
<br />
<br />
If we looked at the page on <code class="highlighter-rouge">https://10.10.10.131</code>, you can see that we get certificate error.
<br />
I found <code class="highlighter-rouge">ca.key</code> in the directory <code class="highlighter-rouge">/home/nairobi</code> <br />
<img src="/images/hackthebox/lacasa/cakey.png" alt="" />
<br />
If you wondering whether I can read files then I can read <code class="highlighter-rouge">user.txt</code>. But that is not the case. I donâ€™t have permission to read <code class="highlighter-rouge">user.txt</code>.
<br /><br />
We can see that we need a certificate to access the site on <code class="highlighter-rouge">https://19.10.10.131/</code> and we have a <code class="highlighter-rouge">ca.key</code> from the shell on <code class="highlighter-rouge">port 6200</code><br />
The next step is to create a client certificate using <code class="highlighter-rouge">ca.key</code> and the existing certificate that we export from <code class="highlighter-rouge">https://10.10.10.131/</code>
<br /><br />
The resources that I used for this section :<br /></p>
<ol>
  <li><a href="https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs">https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs</a><br /></li>
  <li><a href="https://medium.com/@sevcsik/authentication-using-https-client-certificates-3c9d270e8326">https://medium.com/@sevcsik/authentication-using-https-client-certificates-3c9d270e8326</a><br />
<br /></li>
</ol>

<p>To create client certificate, we have to generate a Private Key and Certificate Signing Requests(CSR)<br />
<code class="highlighter-rouge">openssl req  -newkey rsa:2048 -nodes -keyout mykey.key -out mykey.csr</code>
<br /></p>

<p>The next step is to create a client certificate by using <code class="highlighter-rouge">ca.key</code><br />
<code class="highlighter-rouge">openssl x509 -req -in mykey.csr -CA lacasadepapel_htb.crt -CAkey ca.key -out myclient.pem -set_serial 01 -days 365</code>
<br /></p>

<p>To import this certificate to Firefox, we have to convert it into PKCS12 format.<br />
<code class="highlighter-rouge">openssl  pkcs12 -export -inkey domain.key -in client.pem -out client.p12</code>
<br />
<br />
I imported <code class="highlighter-rouge">client.pk12</code> in Firefox and reloaded the web page.
<br />
<img src="/images/hackthebox/lacasa/privatearea.png" width="90%" />
<br /></p>

<p>We can see a nice private area. After clicking around, I found something interesting. The url <code class="highlighter-rouge">https://10.10.10.131/?path=SEASON-1</code> uses <code class="highlighter-rouge">path</code> to search for files.
If we enter a valid path following the <code class="highlighter-rouge">path=</code>, we can read the contents of the directories.
<br />
<img src="/images/hackthebox/lacasa/ssh1.png" width="90%" />
<br /><br />
Now we canâ€™t just download the file or read the contents of the file.<br />
I used Burpsuite to see what requests are sent while downloading a file. You can do that by starting Burp and clicking on any file in Season-1 folder.<br />
<img src="/images/hackthebox/lacasa/burp.png" />
<br /></p>

<p>The request sent is <code class="highlighter-rouge">GET /file/U0VBU09OLTEvMDEuYXZp</code>, where the file name is encoded in base-64. You can verify it by <code class="highlighter-rouge">echo 'U0VBU09OLTEvMDEuYXZp' | base64 -d</code><br /><br />
Now I want something to that will help me log into the machine. There is <code class="highlighter-rouge">.ssh</code> folder, I can try to download the private key <code class="highlighter-rouge">id_rsa</code> and see if I hit any luck.
<br /><br />
To download that we have to convert the path into base64 - <code class="highlighter-rouge">echo -n ../.ssh/id_rsa | base64</code>. We get <code class="highlighter-rouge">Li4vLnNzaC9pZF9yc2E=</code><br />
<br />
It worked!&lt;br/:w</p>
<blockquote>

  <p><img src="/images/hackthebox/lacasa/idrsa.png" width="90%" />
<br /><br />
Now we can just have to login using the private key. For user, I had to do trial and error to find out that that the key was for the user <code class="highlighter-rouge">professor</code> <br /></p>
</blockquote>

<p><img src="/images/hackthebox/lacasa/ssh.png" /><br /></p>

<p>Once I am logged in, I canâ€™t read <code class="highlighter-rouge">user.txt</code> <code class="highlighter-rouge">:(</code><br /><br />
But I see some interesting files in the <code class="highlighter-rouge">professor's</code> home directory.<br /></p>

<p><img src="/images/hackthebox/lacasa/priv.png" /><br /></p>

<p>By looking at the processes by using <code class="highlighter-rouge">ps</code> command, we can see that <code class="highlighter-rouge">/usr/bin/node</code> is executing whatever is in <code class="highlighter-rouge">memcached.js</code> and <code class="highlighter-rouge">memcached.ini</code> is file that calls that process.</p>

<p><img src="/images/hackthebox/lacasa/priv1.png" /><br /></p>

<p>If we can edit or change this <code class="highlighter-rouge">memcached.ini</code> file, then we can run anything as root. After some trial and error, I found out that, I cannot edit <code class="highlighter-rouge">memcached.ini</code> but I can move it and place my own <code class="highlighter-rouge">memcached.ini</code> file.</p>

<p><br />
<img src="/images/hackthebox/lacasa/priv2.png" />
<br />
<br />
We have root!<br />
<br />
<img src="/images/hackthebox/lacasa/root.png" />
<br /><br />
I can read both <code class="highlighter-rouge">user.txt</code> and <code class="highlighter-rouge">root.txt</code> flags.<br />
<img src="/images/hackthebox/lacasa/flags.png" /></p>

  </div>

</article>

</section>
<!-- <nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">
  </div>
</nav>
 -->
  </body>

</html>
